import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { FaDownload, FaPrint, FaFileInvoice } from 'react-icons/fa';
import Pagination from '../../../../components/Pagination';
import DynamicTable from '../../../../components/microcomponents/DynamicTable';

const BillingTable = () => {
  const [payments, setPayments] = useState([]), [loading, setLoading] = useState(true), [error, setError] = useState(null), [selectedInvoice, setSelectedInvoice] = useState(null), [page, setPage] = useState(1);
  const rowsPerPage = 4;
  useEffect(() => { fetchPayments(); }, []);
  const fetchPayments = async () => { try { const response = await axios.get('https://681b32bd17018fe5057a8bcb.mockapi.io/paybook'); setPayments(response.data); setLoading(false); } catch (err) { setError('Failed to fetch payment data'); setLoading(false); } };
  const getInvoiceTemplate = (invoice) => `<!DOCTYPE html><html><head><title>Invoice ${invoice.invoiceNo}</title><style>body{font-family:Arial,sans-serif;margin:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background-color:#f2f2f2}</style></head><body><h1>AV Swasthya Invoice</h1><p>Invoice No: ${invoice.invoiceNo}</p><p>Date: ${invoice.date}</p><p>Patient: ${invoice.patientName}</p><p>Doctor: ${invoice.doctorName}</p><p>Service: ${invoice.serviceType}</p><p>Amount: ₹${invoice.amount}</p></body></html>`;
  const downloadInvoice = (invoice) => { const content = getInvoiceTemplate(invoice), blob = new Blob([content], { type: 'text/html' }), url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `AV_Swasthya_Invoice_${invoice.invoiceNo}.html`; document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url); };
  const printInvoice = (invoice) => { const win = window.open('', '_blank'); win.document.write(getInvoiceTemplate(invoice)); win.document.close(); win.onload = () => { win.print(); win.close(); }; };
  const columns = [{ header: 'Date', accessor: 'date' }, { header: 'Invoice No', accessor: 'invoiceNo' }, { header: 'Doctor', accessor: 'doctorName' }, { header: 'Service', accessor: 'serviceType' }, { header: 'Amount', accessor: 'amount', cell: (row) => `₹${row.amount}` }, { header: 'Method', accessor: 'method', cell: (row) => row.method.toUpperCase() }, { header: 'Action', accessor: 'action', clickable: true, cell: () => <button className="relative group inline-flex items-center gap-1 px-3 py-1 sm:gap-2 sm:px-4 sm:py-2 font-semibold text-[var(--accent-color)] border border-[var(--accent-color)] rounded-lg overflow-hidden transition-all duration-300 hover:shadow-lg hover:scale-102 hover:bg-[var(--accent-color)] hover:text-white text-xs sm:text-sm"><FaFileInvoice className="text-base sm:text-lg transition-transform duration-300 group-hover:-translate-y-0.5 group-hover:rotate-6 group-hover:scale-105" /><span className="absolute inset-0 overflow-hidden rounded-lg"><span className="absolute left-[-75%] top-0 h-full w-1/3 transform rotate-12 bg-white opacity-10 group-hover:animate-shimmer"></span></span></button> }];
  const filters = [{ key: 'method', label: 'Payment Method', options: [{ value: 'cash', label: 'Cash' }, { value: 'card', label: 'Card' }, { value: 'upi', label: 'UPI' }] }];
  const tabs = [{ value: 'all', label: 'All' }, { value: 'paid', label: 'Paid' }];
  const tabActions = [{ label: 'Export', onClick: () => alert('Export clicked'), className: 'px-2 py-1 sm:px-4 sm:py-2 bg-[var(--accent-color)] text-white rounded-lg hover:bg-opacity-90 text-xs sm:text-sm' }];
  const handleCellClick = (row) => setSelectedInvoice(row);
  const handleTabChange = (tabValue) => {};
  const totalPages = Math.ceil(payments.length / rowsPerPage);
  const paginatedRows = payments.slice((page - 1) * rowsPerPage, page * rowsPerPage);

  return (
    <div className="pt-4 sm:pt-6 bg-white p-4 sm:p-6 rounded-xl sm:rounded-2xl shadow-lg w-full overflow-x-auto">
      <h3 className="text-lg sm:text-xl font-bold mb-3 sm:mb-4">Billing History</h3>
      <div className="overflow-x-auto">
        <DynamicTable columns={columns} data={paginatedRows} onCellClick={handleCellClick} filters={filters} tabs={tabs} tabActions={tabActions} activeTab="all" onTabChange={handleTabChange} showSearchBar={true} />
      </div>
      <div className="w-full flex justify-end mt-3 sm:mt-4">
        <Pagination page={page} totalPages={totalPages} onPageChange={(newPage) => setPage(newPage)} />
      </div>
      {selectedInvoice && <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-2 sm:p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md sm:max-w-3xl max-h-[90vh] overflow-y-auto"><div className="p-4 sm:p-6 border-b border-gray-200 flex justify-between items-start"><div><h1 className="text-lg sm:text-xl font-bold">AV Swasthya</h1><p className="text-sm sm:text-base text-gray-600">Healthcare & Wellness Center</p><p className="text-sm sm:text-base text-gray-600">123 Health Avenue, Medical District</p><p className="text-sm sm:text-base text-gray-600">+91 98765 43210</p><p className="text-sm sm:text-base text-gray-600">contact@avswasthya.com</p></div><button onClick={() => setSelectedInvoice(null)} title="Close" className="text-gray-400 hover:text-gray-600 transition text-xl">✕</button></div><div className="p-4 sm:p-6"><h4 className="text-base sm:text-lg font-semibold mb-2">Invoice Details</h4><div className="space-y-1 text-sm sm:text-base"><p><span className="font-medium">Invoice No:</span> {selectedInvoice.invoiceNo}</p><p><span className="font-medium">Date:</span> {selectedInvoice.date}</p><p><span className="font-medium">Status:</span> <strong className="text-green-600">Paid</strong></p></div><div className="mt-4 p-4 sm:p-6 bg-gray-50 rounded-lg"><h4 className="text-base sm:text-lg font-semibold mb-2">Patient Information</h4><div className="space-y-1 text-sm sm:text-base"><p><span className="font-medium">Name:</span> {selectedInvoice.patientName}</p><p><span className="font-medium">Doctor:</span> {selectedInvoice.doctorName}</p></div></div><div className="mt-4"><table className="w-full border-collapse"><thead><tr className="bg-gray-100"><th className="p-2 sm:p-3 text-left text-xs sm:text-sm">Description</th><th className="p-2 sm:p-3 text-left text-xs sm:text-sm">Method</th><th className="p-2 sm:p-3 text-right text-xs sm:text-sm">Amount</th></tr></thead><tbody><tr className="border-t"><td className="p-2 sm:p-3">{selectedInvoice.serviceType}</td><td className="p-2 sm:p-3">{selectedInvoice.method.toUpperCase()}</td><td className="p-2 sm:p-3 text-right">₹{selectedInvoice.amount}</td></tr></tbody></table><div className="mt-3 sm:mt-4 text-right text-sm sm:text-base"><div className="space-y-1"><div className="flex justify-between"><span>Subtotal:</span><span>₹{selectedInvoice.amount}</span></div><div className="flex justify-between"><span>Tax (0%):</span><span>₹0.00</span></div><div className="flex justify-between border-t border-gray-200 pt-1 sm:pt-2 mt-1 sm:mt-2 font-bold"><span>Total:</span><span>₹{selectedInvoice.amount}</span></div></div></div></div></div><div className="p-4 sm:p-6 border-t border-gray-200 text-center"><p className="text-sm sm:text-base mb-3 sm:mb-4">Thank you for choosing AV Swasthya for your healthcare needs.</p><div className="flex flex-col sm:flex-row justify-center gap-2"><button onClick={() => downloadInvoice(selectedInvoice)} className="flex items-center justify-center gap-1 sm:gap-2 px-3 sm:px-4 py-1 sm:py-2 bg-[var(--accent-color)] text-white rounded-lg hover:bg-opacity-90 text-xs sm:text-sm"><FaDownload />Download</button><button onClick={() => printInvoice(selectedInvoice)} className="flex items-center justify-center gap-1 sm:gap-2 px-3 sm:px-4 py-1 sm:py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 text-xs sm:text-sm"><FaPrint />Print</button></div></div></div></div>}
    </div>
  );
};

export default BillingTable;
